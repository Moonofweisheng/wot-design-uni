var t=Object.defineProperty,e=Object.defineProperties,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,n=(e,a,s)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[a]=s,r=(t,e)=>{for(var a in e||(e={}))l.call(e,a)&&n(t,a,e[a]);if(s)for(var a of s(e))i.call(e,a)&&n(t,a,e[a]);return t},o=(t,s)=>e(t,a(s));import{d as u,K as c,r as d,Z as h,aj as v,I as p,c as f,C as g,H as m,D as y,y as x,a7 as b,e as W,f as w,b as T,g as k,w as C,h as S,i as P,$ as X,G as Y,E as M,m as _,z as F,F as H,j,t as q,l as L,M as O,a2 as $,a0 as D}from"./index-Bxqg77pZ.js";import{_ as N}from"./wd-button.Dfw0jUO9.js";import{c as I,n as R,_ as z}from"./base64.C49xnrUQ.js";import{u as E}from"./useTranslate.CsR2puND.js";const B=o(r({},I),{penColor:{type:String,default:"#000"},lineWidth:{type:Number,default:3},clearText:String,revokeText:String,restoreText:String,confirmText:String,fileType:{type:String,default:"png"},quality:{type:Number,default:1},exportScale:{type:Number,default:1},disabled:{type:Boolean,default:!1},height:R,width:R,backgroundColor:String,disableScroll:{type:Boolean,default:!0},enableHistory:{type:Boolean,default:!1},step:{type:Number,default:1},undoText:String,redoText:String,pressure:{type:Boolean,default:!1},minWidth:{type:Number,default:2},maxWidth:{type:Number,default:6},minSpeed:{type:Number,default:1.5}}),G=z(u(o(r({},{name:"wd-signature",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"}}),{props:B,emits:["start","end","signing","confirm","clear"],setup(t,{expose:e,emit:a}){const s=t,l=a,{translate:i}=E("signature"),{proxy:n}=c(),u=d(`signature${h()}`);let I=null;const R=d(!1),z=d(1),B=v({canvasWidth:0,canvasHeight:0,ctx:null});function G(t){if(!t)return!0;if(["transparent","#0000","#00000000"].includes(t.toLowerCase()))return!0;const e=t.match(/^rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*(\d*\.?\d+))?\)$/i);if(e){return 0===(e[4]?parseFloat(e[4]):1)}const a=t.match(/^hsla?\(\s*(\d+)(?:deg)?\s*,\s*(\d+)%\s*,\s*(\d+)%(?:\s*,\s*(\d*\.?\d+))?\)$/i);if(a){return 0===(a[4]?parseFloat(a[4]):1)}const s=t.match(/^#([0-9a-f]{8}|[0-9a-f]{4})$/i);if(s){const t=s[1],e=8===t.length?t.slice(6,8):t.slice(3,4).repeat(2);return 0===parseInt(e,16)}return!1}p((()=>s.penColor),(()=>{ct()})),p((()=>s.lineWidth),(()=>{ct()}));const J=f((()=>{const t={};return g(s.width)&&(t.width=m(s.width)),g(s.height)&&(t.height=m(s.height)),`${y(t)}`})),K=f((()=>s.disableScroll)),U=f((()=>s.enableHistory)),Z=d([]),A=d([]),Q=d(),V=d(0);const tt=()=>s.pressure?(s.maxWidth+s.minWidth)/2:s.lineWidth,et=t=>{t.preventDefault(),R.value=!0,ct(),l("start",t);const{x:e,y:a}=t.touches[0];Q.value={points:[{x:e,y:a,t:Date.now()}],color:s.penColor,width:tt(),backgroundColor:s.backgroundColor,isPressure:s.pressure},A.value=[],nt(t)},at=t=>{t.preventDefault(),R.value=!1,Q.value&&(Z.value.push(o(r({},Q.value),{points:Q.value.points.map((t=>o(r({},t),{t:t.t,speed:t.speed,distance:t.distance,lineWidth:t.lineWidth,lastX1:t.lastX1,lastY1:t.lastY1,lastX2:t.lastX2,lastY2:t.lastY2,isFirstPoint:t.isFirstPoint})))})),V.value=Z.value.length),Q.value=void 0;const{ctx:e}=B;e&&e.beginPath(),l("end",t)},st=(t=!1)=>{!t&&B.canvasHeight&&B.canvasWidth||new Promise((t=>{const{ctx:e}=B;if(e)return t(e);O(`#${u.value}`,!1,n).then((e=>{var a,s;a=e.width,s=e.height,B.canvasHeight=s*z.value,B.canvasWidth=a*z.value,B.ctx=$(u.value,n),B.ctx&&B.ctx.scale(z.value,z.value),t(B.ctx)}))})).then((()=>{const{ctx:t}=B;t&&g(s.backgroundColor)&&(t.setFillStyle(s.backgroundColor),t.fillRect(0,0,B.canvasWidth,B.canvasHeight),t.draw())}))},lt=()=>{Z.value=[],A.value=[],V.value=0,function(){const{canvasWidth:t,canvasHeight:e,ctx:a}=B;a&&(a.clearRect(0,0,t,e),G(s.backgroundColor)||(a.setFillStyle(s.backgroundColor),a.fillRect(0,0,t,e)),a.draw())}(),l("clear")},it=()=>{!function(){const{fileType:t,quality:e,exportScale:a}=s,{canvasWidth:i,canvasHeight:r}=B;D({width:i,height:r,destWidth:i*a,destHeight:r*a,fileType:t,quality:e,canvasId:u.value,canvas:I,success:t=>{const e={tempFilePath:t.tempFilePath,width:i*a/z.value,height:r*a/z.value,success:!0};l("confirm",e)},fail:()=>{const t={tempFilePath:"",width:i*a/z.value,height:r*a/z.value,success:!1};l("confirm",t)}},n)}()},nt=t=>{t.preventDefault();const{ctx:e}=B;if(!R.value||s.disabled||!e)return;const{x:a,y:i}=t.touches[0],n={x:a,y:i,t:Date.now()};if(Q.value){const t=Q.value.points,l=t[t.length-1];if(l.t===n.t||l.x===a&&l.y===i)return;if(n.distance=Math.sqrt(Math.pow(n.x-l.x,2)+Math.pow(n.y-l.y,2)),n.speed=n.distance/(n.t-l.t||.1),s.pressure&&(n.lineWidth=function(t){if(!s.pressure)return s.lineWidth;const e=s.minSpeed||1.5,a=Math.min(10*e,Math.max(e,t)),l=(s.maxWidth-s.minWidth)*(a-e)/e,i=Math.max(s.maxWidth-l,s.minWidth);return Math.min(i,s.maxWidth)}(n.speed),t.length>=2)){if(t[t.length-2].lineWidth&&l.lineWidth){const t=(n.lineWidth-l.lineWidth)/l.lineWidth,e=.2;if(Math.abs(t)>e){const a=t>0?e:-.2;n.lineWidth=l.lineWidth*(1+a)}}}t.push(n),s.pressure?t.length>=2&&function(t,e){const{ctx:a}=B;if(!a)return;const l=e.x-t.x,i=e.y-t.y;if(Math.sqrt(l*l+i*i)<=2)e.lastX1=e.lastX2=t.x+.5*l,e.lastY1=e.lastY2=t.y+.5*i;else{const a=e.speed||0,n=s.minSpeed||1.5,r=Math.max(.1,Math.min(.9,a/(10*n)));e.lastX1=t.x+l*(.2+.3*r),e.lastY1=t.y+i*(.2+.3*r),e.lastX2=t.x+l*(.8-.3*r),e.lastY2=t.y+i*(.8-.3*r)}const n=e.lineWidth||s.lineWidth;"number"==typeof t.lastX1?(a.setLineWidth(n),a.beginPath(),a.moveTo(t.lastX2,t.lastY2),a.quadraticCurveTo(t.x,t.y,e.lastX1,e.lastY1),a.stroke(),t.isFirstPoint||(a.beginPath(),a.moveTo(t.lastX1,t.lastY1),a.quadraticCurveTo(t.x,t.y,t.lastX2,t.lastY2),a.stroke()),a.draw(!0)):e.isFirstPoint=!0}(l,n):(e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(n.x,n.y),e.stroke(),e.draw(!0))}l("signing",t)},rt=()=>{const{ctx:t}=B;t&&(G(s.backgroundColor)?t.clearRect(0,0,B.canvasWidth,B.canvasHeight):(t.setFillStyle(s.backgroundColor),t.fillRect(0,0,B.canvasWidth,B.canvasHeight)),0!==Z.value.length?(Z.value.forEach((e=>{e.points.length&&(t.setStrokeStyle(e.color),t.setLineJoin("round"),t.setLineCap("round"),e.isPressure&&s.pressure?e.points.forEach(((a,l)=>{if(0===l)return;const i=e.points[l-1],n=a.x-i.x,r=a.y-i.y;if(Math.sqrt(n*n+r*r)<=2)a.lastX1=a.lastX2=i.x+.5*n,a.lastY1=a.lastY2=i.y+.5*r;else{const t=a.speed||0,e=s.minSpeed||1.5,l=Math.max(.1,Math.min(.9,t/(10*e)));a.lastX1=i.x+n*(.2+.3*l),a.lastY1=i.y+r*(.2+.3*l),a.lastX2=i.x+n*(.8-.3*l),a.lastY2=i.y+r*(.8-.3*l)}const o=a.lineWidth||e.width;"number"==typeof i.lastX1?(t.setLineWidth(o),t.beginPath(),t.moveTo(i.lastX2,i.lastY2),t.quadraticCurveTo(i.x,i.y,a.lastX1,a.lastY1),t.stroke(),i.isFirstPoint||(t.beginPath(),t.moveTo(i.lastX1,i.lastY1),t.quadraticCurveTo(i.x,i.y,i.lastX2,i.lastY2),t.stroke())):a.isFirstPoint=!0})):(t.setLineWidth(e.width),e.points.forEach(((a,s)=>{if(0===s)return;const l=e.points[s-1];t.beginPath(),t.moveTo(l.x,l.y),t.lineTo(a.x,a.y),t.stroke()}))))})),t.draw()):t.draw())},ot=()=>{if(!Z.value.length)return;const t=Math.min(s.step,Z.value.length),e=Z.value.splice(Z.value.length-t);A.value.push(...e),V.value=Math.max(0,V.value-t),rt()},ut=()=>{if(!A.value.length)return;const t=Math.min(s.step,A.value.length),e=A.value.splice(A.value.length-t);Z.value.push(...e),V.value=Math.min(Z.value.length,V.value+t),rt()};function ct(){const{ctx:t}=B;t&&(t.setLineWidth(tt()),t.setStrokeStyle(s.penColor),t.setLineJoin("round"),t.setLineCap("round"))}return x((()=>{st()})),b((()=>{})),e({init:st,clear:lt,confirm:it,restore:ut,revoke:ot}),(t,e)=>{const a=X,s=P,l=W(w("wd-button"),N);return k(),T(s,{class:"wd-signature"},{default:C((()=>[S(s,{class:"wd-signature__content"},{default:C((()=>[S(a,{class:"wd-signature__content-canvas","canvas-id":u.value,style:Y(J.value),width:B.canvasWidth,height:B.canvasHeight,id:u.value,"disable-scroll":K.value,onTouchstart:et,onTouchend:at,onTouchmove:nt},null,8,["canvas-id","style","width","height","id","disable-scroll"])])),_:1}),S(s,{class:"wd-signature__footer"},{default:C((()=>[M(t.$slots,"footer",{clear:lt,confirm:it,currentStep:V.value,revoke:ot,restore:ut,canUndo:Z.value.length>0,canRedo:A.value.length>0,historyList:Z.value},(()=>[U.value?(k(),_(H,{key:0},[S(l,{size:"small",plain:"",onClick:ot,disabled:Z.value.length<=0},{default:C((()=>[j(q(t.revokeText||L(i)("revokeText")),1)])),_:1},8,["disabled"]),S(l,{size:"small",plain:"",onClick:ut,disabled:A.value.length<=0},{default:C((()=>[j(q(t.restoreText||L(i)("restoreText")),1)])),_:1},8,["disabled"])],64)):F("",!0),S(l,{size:"small",plain:"",onClick:lt},{default:C((()=>[j(q(t.clearText||L(i)("clearText")),1)])),_:1}),S(l,{size:"small",onClick:it},{default:C((()=>[j(q(t.confirmText||L(i)("confirmText")),1)])),_:1})]),!0)])),_:3})])),_:3})}}})),[["__scopeId","data-v-37aa24ef"]]);export{G as _};
